---
title: "My tips for working with ggplot2 in a RMarkdown document"
author: "Benjamin Louis"
date: '2020-05-21'
slug: en
categories:
  - configuration
  - tips
tags:
  - R
  - rmarkdown
  - ggplot2
banner: 'img/banners/rmarkdown-ggplot2.png'
type: 'blog'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.align = "center",
  out.width = "70%",
  fig.width = 7)
```


<!--Writing a report with [R Markdown](https://rmarkdown.rstudio.com/) combined with [`ggplot2`](https://ggplot2.tidyverse.org/) visualisation is a real advantage for reproducible data analysis. Features of both packages are highly flexible and you CAN always get what you want! But if you are just starting out, getting what you want can be cumbersome In this post, I share with you some tips found over time.-->

<!--more-->

# Context

Writing [R Markdown](https://rmarkdown.rstudio.com/) document makes possible to insert R code and its results in a report with a choosen output format (HTML, PDF, Word). It is a real asset for analysis reproducibility as well as communication of methods and results. Doing daily data analysis, I usually deliver outputs in report and R Markdown naturally became an essential tool of my workflow.

Data analysis without data visualisation is like playing darts in the dark, there is a good chance you'll miss the ~~bullseye~~ point. You'll find quite a few R packages to build graphics but I have a preference for [`ggplot2`](https://ggplot2.tidyverse.org/) (I'm not alone!). Therefore, `ggplot2` graphics are often included in my R Markdown documents.

Features of both packages are highly flexible and you **CAN** always get what you want ! But if you are just starting out, getting what you want can be cumbersome. In this post, I share with you some tips found over time.

__Requirements__


1. I assume you have already made a graphic with `ggplot2` or at least seen some `ggplot2` code. If not, you can have a look at [this book](https://ggplot2-book.org/) freely available online. To [avoid iris data](https://www.garrickadenbuie.com/blog/lets-move-on-from-iris/), I will use a data visualisation of [Antartica penguins data](https://github.com/allisonhorst/penguins) recently included in a R package by [Allison Horst](https://twitter.com/allison_horst?s=20) (go see her [illustrations](https://github.com/allisonhorst/stats-illustrations) too !). I start with this graphic :

```{r echo = FALSE, message = FALSE, results = 'hide', cache = TRUE}
library(tidyverse)
library(janitor)
# Adelie penguin data from: https://doi.org/10.6073/pasta/abc50eed9138b75f54eaada0841b9b86
uri_adelie <- "https://portal.edirepository.org/nis/dataviewer?packageid=knb-lter-pal.219.3&entityid=002f3893385f710df69eeebe893144ff"
# Gentoo penguin data from: https://doi.org/10.6073/pasta/2b1cff60f81640f182433d23e68541ce
uri_gentoo <- "https://portal.edirepository.org/nis/dataviewer?packageid=knb-lter-pal.220.3&entityid=e03b43c924f226486f2f0ab6709d2381"
# Chinstrap penguin data from: https://doi.org/10.6073/pasta/409c808f8fc9899d02401bdb04580af7
uri_chinstrap <- "https://portal.edirepository.org/nis/dataviewer?packageid=knb-lter-pal.221.2&entityid=fe853aa8f7a59aa84cdd3197619ef462"
# Combining the URIs
uris <- c(uri_adelie, uri_gentoo, uri_chinstrap)
# Downloading and importing data
penguins_raw <- map_dfr(uris, read_csv) %>% 
  clean_names() %>%
  mutate(species_short = word(species, 1)) %>%
  select(species_short,
         island,
         culmen_length_mm,
         culmen_depth_mm,
         flipper_length_mm,
         body_mass_g,
         sex) %>%
  rename(species = species_short)
```


```{r}
library(ggplot2)
p <- ggplot(penguins_raw, aes(x = culmen_length_mm, y = culmen_depth_mm, color = species, fill = species)) +
  geom_point() +
  geom_smooth(method = "lm", formula = "y ~ x", alpha = 0.3) +
  scale_color_viridis_d() +
  scale_fill_viridis_d() +
  labs(x = "Culmen Length (mm)", y = "Culmen depth (mm)", fill = "Species", color = "Species")
p
```

2. Besides, it's better if you know how to create a R Markdown document and you know how to include R code in it (with a _chunk_). If not, start [here](https://bookdown.org/yihui/rmarkdown/).

# Making your own `ggplot2` theme

`ggplot2` theme manages how your graphic looks like. All elemements can be changed through the [`theme()`](https://ggplot2.tidyverse.org/reference/theme.html) function but there also are pre-configured. The default theme used by `ggplot2` is `theme_gray()` but I often switch for `theme_bw()` (for _black and white_).


```{r animation.hook="gifski", interval = 2}
p + labs(title = "Thème par défaut")
p + theme_bw() + labs(title = "Avec theme_bw()")
```   

If you always use the same modifications with `theme()` function, I highly suggest that you create your own theme. Here is a customised one :

```{r}
theme_ben <- function(base_size = 14) {
  theme_bw(base_size = base_size) %+replace%
    theme(
      # L'ensemble de la figure
      plot.title = element_text(size = rel(1), face = "bold", margin = margin(0,0,5,0), hjust = 0),
      # Zone où se situe le graphique
      panel.grid.minor = element_blank(),
      panel.border = element_blank(),
      # Les axes
      axis.title = element_text(size = rel(0.85), face = "bold"),
      axis.text = element_text(size = rel(0.70), face = "bold"),
      axis.line = element_line(color = "black", arrow = arrow(length = unit(0.3, "lines"), type = "closed")),
      # La légende
      legend.title = element_text(size = rel(0.85), face = "bold"),
      legend.text = element_text(size = rel(0.70), face = "bold"),
      legend.key = element_rect(fill = "transparent", colour = NA),
      legend.key.size = unit(1.5, "lines"),
      legend.background = element_rect(fill = "transparent", colour = NA),
      # Les étiquettes dans le cas d'un facetting
      strip.background = element_rect(fill = "#17252D", color = "#17252D"),
      strip.text = element_text(size = rel(0.85), face = "bold", color = "white", margin = margin(5,0,5,0))
    )
}
```

And the results compared to the default one :

```{r animation.hook="gifski", interval = 2}
p + labs(title = "Thème par défaut")
p + theme_ben() + labs(title = "Avec mon thème personnalisé")
``` 

Building a customised theme is done by creating a R function where a pre-configured theme is used but some elements are modified with the `theme()` function. The tip is in the use of `%+replace%` in place of the classic `+`. unlike the latter, `%+replace%` doesn't only update elements of a theme but replaces them entirely.

now you just have to let your creativity flows. There are lots of editable elements so the customisation is pretty much limitless. You can find the list of elements in the webpage of the [`theme()`](https://ggplot2.tidyverse.org/reference/theme.html) function. In the example, the modified elements are for the whole figure (`plot.*` elements), the grapihic area (`pnael.*`), the axis (`axis.*`), the legend (`legend.*`) and the graphics labels (`strip.*`) when [facetting](https://ggplot2-book.org/facet.html) is used.

In my opinion, axis and legends are essential elements so my choices go towards highlighted them through their relative size using `rel()` function which return a proportion a the base size (`base_size`) and bolding theme (`face = "bold"`).

Customisation of a `ggplot2` theme can first be hard work but if you are going to often use the same configurations, it's worth it. There are plenty ressources on the web.You can also [contact me](https://benjaminlouis-stat.fr/contact/), I'll be glad to help.

You can now insert your theme in a _chunk_ at the beginning of your R Markdown document to use it all along. You can also create a R package with your theme, among others, and load this package.

# Votre graphique `ggplot` dans R Markdown

## Options des blocs de code pour les figures

Pour intégrer du code R et les résultats de ce code dans un document R Markdown vous utilisez un _chunk_ R avec différentes options :

````markdown
`r ''````{r option1 = valeur_option1, option2 = valeur_option2}
# Le code R ici
`r ''````
````

Certaines de ces options sont spécifiques pour les figures générées par R via ce code :

+ Les options relatives à la taille des figures générées par R

+ Les options relatives à la taille des figures dans le document final


## Taille des figures générées par R

Les options `fig.width` et `fig.height` permettent respectivement de fixer la largeur et la hauteur de la figure générée par R. Par défaut, leur valeur est fixer à 7 (les dimensions sont en pouces). Une alternative que je préfère personnellement est d'utiliser une seule de ces valeurs (`fig.width`) en association avec une autre option `fig.asp` qui fixe le ratio _hauteur/largeur_ de la figure. Il m'est personnellement plus facile de penser directement en terme de ratio que de donner une taille pour la largeur et une pour la hauteur séparément. Par défaut, `fig.asp` est `NULL` mais je le fixe très souvent à $0,8$ car c'est un ratio qui correspond très souvent au résultat que je cherche.

Les options de taille de la figure générée par R ont des conséquences sur la taille relative des éléments de la figure. Pour une figure `ggplot2`, ces éléments resteront à la taille définie dans le thème utilisée quelque soit la taille globale choisie pour la figure. Une taille importante peut donner un rendu de texte trop petit et vice versa.

<div class = "grid-container">
<div class = "row">
<div class = "col-6">

__`fig.width = 3` - éléments du graphique relativement trop grands__

````markdown
`r ''````{r fig.asp = 0.8, fig.width = 3}
p + theme_ben()
`r ''````
````

```{r echo = FALSE, fig.asp = 0.8, fig.width = 3, out.width = "95%"}
p + theme_ben()
```

</div>
<div class = "col-6">

__`fig.width = 10` - éléments du graphique relativement trop petits__


````markdown
`r ''````{r fig.asp = 0.8, fig.width = 10}
p + theme_ben()
`r ''````
````

```{r echo = FALSE, fig.asp = 0.8, fig.width = 10, out.width = "95%"}
p + theme_ben()
```

</div>
</div>
</div>

Pour avoir le rendu qui vous plaît, il vous faudra donc combiner entre les tailles choisies dans votre thème et celles utilisées dans les options du code. Pour mon thème, la taille par défaut (`7`) correspond à ce que je veux.

````markdown
`r ''````{r fig.asp = 0.8, fig.width = 7}
p + theme_ben()
`r ''````
````

```{r echo = FALSE, fig.asp = 0.8, fig.width = 7}
p + theme_ben()
```


Lorsque les textes des axes sont plus longs ou que le graphique est chargé, je peux choisir une taille plus importante (`8` ou `9`) pour que que les éléments du graphique soit relativement plus petit. Notez que pour le texte, une simple modification de la taille de base dans le thème suffit. Vous pouvez alors obtenir des graphiques similaires en modifiant l'un ou l'autre.


<div class = "grid-container">
<div class = "row">
<div class = "col-6">

__`fig.width = 9` - `base_size = 14` (défaut)__

````markdown
`r ''````{r fig.asp = 0.8, fig.width = 9}
p + theme_ben(base_size = 14)
`r ''````
````

```{r echo = FALSE, fig.asp = 0.8, fig.width = 9, out.width = "95%"}
p + theme_ben(base_size = 14)
```

</div>
<div class = "col-6">

__`fig.width = 7` (défaut) - `base_size = 12`__


````markdown
`r ''````{r fig.asp = 0.8, fig.width = 7}
p + theme_ben(base_size = 12)
`r ''````
````

```{r echo = FALSE, fig.asp = 0.8, fig.width = 7, out.width = "95%"}
p + theme_ben(base_size = 12)
```

</div>
</div>
</div>

## Taille de la figure dans le document

Les figures générées par R dans un document RMarkdown sont exportées (en format png par défaut) avant d'être insérées dans le document final. Il est possible de modifier la taille de la figure dans le document final avec les options `out.width` et `out.height`.  

Il est rare que j'ai à revoir le ratio entre hauteur et largeur après avoir généré la figure dans R, j'utilise donc quasi-systématiquement uniquement `out.width`. La solution qui me paraît la plus favorable pour définir une valeur est en pourcentage. Ainsi, une valeur de 100% donne :

````markdown
`r ''````{r fig.asp = 0.8, fig.width = 7, out.width = "100%}
p + theme_ben()
`r ''````
````

```{r echo = FALSE, fig.asp = 0.8, fig.width = 7, out.width = "100%"}
p + theme_ben()
```

tandis qu'une valeur de 50% donne :

````markdown
`r ''````{r fig.asp = 0.8, fig.width = 7, out.width = "50%}
p + theme_ben()
`r ''````
````

```{r echo = FALSE, fig.asp = 0.8, fig.width = 7, out.width = "50%"}
p + theme_ben()
```

Vous voyez que cette fois-ci, la taille relative des éléments est inchangée. Le graphique est le même, il est simplement montré avec une taille plus ou moins grande.

# Éviter de vous répéter

Il est toujours frustrant de devoir écrire plusieurs fois la même chose dans une document. Ici, à chaque bloc de code avec une figure `ggplot2`, il faut préciser notre nouveau thème et les valeurs des options du code correspondant à la taille de la figure. Pas de panique, il existe des solutions pour combler votre (ma!) fainéantise.

## Changer le thème `ggplot2` par défaut

Vous pouvez changer le thème par défaut pour `ggplot2` avec la fonction `theme_set()`. Il suffit pour cela de mettre après création de votre thème (ou chargement du package le contenant) la commande :

```{r eval = FALSE}
theme_set(theme_ben()) # remplacer theme_ben() par le nom du thème voulu
```

## Changer les valeurs par défaut des options des blocs de code

Vous pouvez changer les valeurs par défaut des options des blocs de code en mettant celui-ci en début de document :

````markdown
`r ''````{r setup, include=FALSE}
knitr::opts_chunk$set(
 fig.width = 6,
 fig.asp = 0.8,
 out.width = "80%"
)
`r ''````
````
Ces valeurs seront appliquées à tous les blocs de code sauf spécification contraire ponctuelle. Vous pouvez alors mettre les options que vous utilisez souvent et éviter d'avoir à les recopier à chaque fois.

## À quoi peut ressembler le début de votre document R Markdown

Avec ces astuces, voilà à quoi peut ressembler le début d'un document RMarkdown dont la sortie sera sous format HTML :


````markdown
---
title: "Mon super titre"
author: "Benjamin Louis"
date: "25/05/2020"
output: html_document
---


`r ''````{r setup, include=FALSE}
# Option de chunk
knitr::opts_chunk$set(
 fig.width = 6,
 fig.asp = 0.8,
 out.width = "80%"
)
`r ''````

`r ''````{r theme_ggplot2, echo = FALSE}
# Création du thème ggplot2
library(ggplot)
theme_ben <- function(base_size = 14) {
  theme_bw(base_size = base_size) %+replace%
    theme(
      # Les options du thème
    )
}
# Changement du thème par défaut
theme_set(theme_ben())
`r ''````
````

À vous désormais de modifier tout ce que vous souhaitez pour créer un thème ggplot2 et mettre vos valeurs préférées d'options de code par défaut. Ces options ne se limitent pas à celles des figures R, n'hésitez pas à consulter [cette page](https://yihui.org/knitr/options/) pour en découvrir d'autres.

J'espère que cette article vous aura aidé à écrire des rapports qui vous plaisent et n'hésitez pas à partager vos astuces en commentaire!

<div class = "smaller">

> #### Disponibilités des données
> 
> - **Données disponibles** via licence [CC-0](https://creativecommons.org/share-your-work/public-domain/cc0/) en accord avec [Palmer Station LTER Data Policy](http://pal.lternet.edu/data/policies) et [LTER Data Access Policy for Type I data](https://lternet.edu/data-access-policy/).
> 
> #### Références des données
> 
> - **Adélie penguins**: Palmer Station Antarctica LTER and K. Gorman. 2020. Structural size measurements and isotopic > signatures of foraging among adult male and female Adélie penguins (*Pygoscelis adeliae*) nesting along the Palmer > Archipelago near Palmer Station, 2007-2009 ver 5. Environmental Data Initiative. > https://doi.org/10.6073/pasta/98b16d7d563f265cb52372c8ca99e60f.
> 
> - **Gentoo penguins**: Palmer Station Antarctica LTER and K. Gorman. 2020. Structural size measurements and isotopic > signatures of foraging among adult male and female Gentoo penguin (*Pygoscelis papua*) nesting along the Palmer > Archipelago near Palmer Station, 2007-2009 ver 5. Environmental Data Initiative. > https://doi.org/10.6073/pasta/7fca67fb28d56ee2ffa3d9370ebda689.
> 
> - **Chinstrap penguins**: Palmer Station Antarctica LTER and K. Gorman. 2020. Structural size measurements and > isotopic signatures of foraging among adult male and female Chinstrap penguin (*Pygoscelis antarcticus*) nesting along > the Palmer Archipelago near Palmer Station, 2007-2009 ver 6. Environmental Data Initiative. > https://doi.org/10.6073/pasta/c14dfcfada8ea13a17536e73eb6fbe9e.
> 
> - **Publication originale:** [**Gorman KB, Williams TD, Fraser WR** (2014) Ecological Sexual Dimorphism and > Environmental Variability within a Community of Antarctic Penguins (Genus *Pygoscelis*). PLoS ONE 9(3): e90081. > doi:10.1371/journal.pone.0090081](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0090081)

</div>
