---
title: "Mes astuces préférées pour travailler avec ggplot dans un document RMarkdown"
author: "Benjamin Louis"
date: '2020-05-21'
slug: fr
categories:
  - configuration
  - astuces
tags:
  - R
  - rmarkdown
  - ggplot2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.align = "center",
  out.width = "70%",
  fig.width = 7)
```

Écrire un document R Markdown (#ref) permet d'insérer du code R et les résultats directement dans un rapport dont on choisira le format de sortie (HTML, PDF, ...). C'est un atout précieux dans la reproductibilité des analyses et dans la communication de méthodes et résultats d'analyse. En tant que personne dont le métier est d'analyser quotidiennement des données pour des clients et de livrer fréquemment les résultats sous forme de rapport, R Markdown est devenu un outil essentiel de mon quotidien.

Une analyse de données passe forcément par l'utilisation de graphique. Il existe tout un panel de packages dans R pour construire des graphiques mais `ggplot2` (#ref) reste mon préféré (et je sais ne pas être seul). J'intégre donc fréquemment des graphiques faits avec `ggplot2` dans mes documents R Markdown.

R markdown et `ggplot2` ont selon moi un avantage commun essentiel : leurs rendus sont hautement personnalisables ! Cet avantage tourne vite à l'inconvénient lorsque l'on débute : il existe tellement d'options qu'il est parfois fastidieux de savoir lesquelles utilisées et comment les combiner. Les configurations qui m'ont demandé le plus de temps sont celles concernant la taille des graphiques et la taille relative des éléments des graphques (textes, légendes, ...). Dans cet article, je vous partage quelques astuces qui me permettent d'arriver à mes objectifs et ceux de mes clients.

__Pré-requis__

1. Dans cette article je pars du principe que vous avez déjà créer un graphique avec `ggplot2` et que vous avez essayer de le personnaliser. Si ça n'est pas le cas, vous pouvez commencer par consulter [ce livre](https://ggplot2-book.org/) disponible gratuitement en ligne. Ici on partira du graphique suivant :

```{r}
library(ggplot2)
p <- ggplot(iris, aes(x = Sepal.Length, y = Petal.Length, color = Species, fill = Species)) +
  geom_point() +
  geom_smooth(method = "lm", formula = "y ~ x", alpha = 0.3) +
  scale_color_viridis_d() +
  scale_fill_viridis_d()
p
```

2. De même, vous êtes familier avec les documents R Markdown et vous savez ce qu'est un _chunk_. Dans le cas contraire, commencez [ici](https://bookdown.org/yihui/rmarkdown/)

# Créer son propre thème `ggplot2`

Le thème `ggplot2` correspond à l'apparence du graphique. Il est possible de changer des éléments un par un via la fonction [`theme()`](https://ggplot2.tidyverse.org/reference/theme.html) mais il existe également des thèmes pré-configurés. Par défaut c'est `theme_gray()` qui est utilisé. Personnellement j'utilise plus souvent `theme_bw()` (pour black and white).


```{r animation.hook="gifski", interval = 2}
p + labs(title = "Thème par défaut")
p + theme_bw() + labs(title = "Avec theme_bw()")
```   

Si vous appliquez souvent les mêmes changements via la fonction `theme()`, je vous recommande fortement de créer votre propre thème. Et un thème c'est avant tout une fonction. Voici un exemple de thème personnalisé :

```{r}
theme_ben <- function(base_size = 14) {
  theme_bw(base_size = base_size) %+replace%
    theme(
      # L'ensemble de la figure
      plot.title = element_text(size = rel(1), face = "bold", margin = margin(0,0,5,0), hjust = 0),
      # Zone où se situe le graphique
      panel.grid.minor = element_blank(),
      panel.border = element_blank(),
      # Les axes
      axis.title = element_text(size = rel(0.85), face = "bold"),
      axis.text = element_text(size = rel(0.70), face = "bold"),
      axis.line = element_line(color = "black", arrow = arrow(length = unit(0.3, "lines"), type = "closed")),
      # La légende
      legend.title = element_text(size = rel(0.85), face = "bold"),
      legend.text = element_text(size = rel(0.70), face = "bold"),
      legend.key = element_rect(fill = "transparent", colour = NA),
      legend.key.size = unit(1.5, "lines"),
      legend.background = element_rect(fill = "transparent", colour = NA),
      # Les étiquettes dans le cas d'un facetting
      strip.background = element_rect(fill = "#17252D", color = "#17252D"),
      strip.text = element_text(size = rel(0.85), face = "bold", color = "white", margin = margin(5,0,5,0))
    )
}
```

Et voici ce que ça donne en comparaison du thème par défaut :

```{r animation.hook="gifski", interval = 2}
p + labs(title = "Thème par défaut")
p + theme_ben() + labs(title = "Avec mon thème personnalisé")
``` 

Pour construire un thème personnalisé on crée donc une fonction R qui part d'un thème `ggplot2` existant qui se rapproche du résultat que l'on veut obtenir et dont on remplace les élèments avec la fonction `theme()`. L'astuce réside dans l'utilisation de `%+replace%` au lieu du traditionnel `+`. Contrairement à ce dernier, `%+replace%` ne fait pas que mettre à jour les éléments d'un thème mais les remplace totalement. 

C'est maintenant qu'il faut faire intervenir votre créativité. La liste des éléments modifiables est très grande et donc la personnalisation très flexible. Si vous ne connaissez pas vraiment ces éléments, commencez par aller voir la page de la fonction [`theme()`](https://ggplot2.tidyverse.org/reference/theme.html). Dans mon exemple, je fais des modifications sur l'ensemble de la figure (élément `plot.*`), sur la zone où est le graphique (`panel.*`), sur les axes (`axis.*`), la légende (`legend.*`) et les étiquettes des graphiques (`strip.*`) lorsque j'utilise du [facetting](https://ggplot2-book.org/facet.html). Les axes et légendes sont pour moi des élèments essentiels et mes choix se portent principalement sur le fait de les mettre plus en valeur que dans le thème par défaut.

La modification d'un thème peut s'avérer complexe au départ mais si vous savez que vous utiliserez très souvent les mêmes réglages, le jeu en vaut la chandelle. Il existe tout un tas de ressources sur internet pour vous aider. N'hésitez pas également à me contacter (#ref), je me ferais un plaisir de vous aider.

Maintenant que c'est fait, vous pouvez intégrer ce thème dans un chunk au début de votre document R Markdown de sorte qu'il soit réutilisable tout le long du document. Vous pouvez également l'intégrer dans un package (#ref) R, peut-être avec d'autres thèmes et charger ce package. 

# Votre graphique `ggplot` dans R Markdown

## Options des chunks pour les figures


## Taille et ratio des figures générées par R

## Taille de la figure dans le document

## Éviter de vous répéter

# À quoi peut ressembler le début de votre document R Markdown

lister les ressources
