---
title: "Mes astuces préférées pour travailler avec ggplot dans un document RMarkdown"
author: "Benjamin Louis"
date: '2020-05-21'
slug: fr
categories:
  - configuration
  - astuces
tags:
  - R
  - rmarkdown
  - ggplot2
---



<p>Écrire un document R Markdown (#ref) permet d’insérer du code R et les résultats directement dans un rapport dont on choisira le format de sortie (HTML, PDF, …). C’est un atout précieux dans la reproductibilité des analyses et dans la communication de méthodes et résultats d’analyse. En tant que personne dont le métier est d’analyser quotidiennement des données pour des clients et de livrer fréquemment les résultats sous forme de rapport, R Markdown est devenu un outil essentiel de mon quotidien.</p>
<p>Une analyse de données passe forcément par l’utilisation de graphique. Il existe tout un panel de packages dans R pour construire des graphiques mais <code>ggplot2</code> (#ref) reste mon préféré (et je sais ne pas être seul). J’intégre donc fréquemment des graphiques faits avec <code>ggplot2</code> dans mes documents R Markdown.</p>
<p>R markdown et <code>ggplot2</code> ont selon moi un avantage commun essentiel : leurs rendus sont hautement personnalisables ! Cet avantage tourne vite à l’inconvénient lorsque l’on débute : il existe tellement d’options qu’il est parfois fastidieux de savoir lesquelles utilisées et comment les combiner. Les configurations qui m’ont demandé le plus de temps sont celles concernant la taille des graphiques et la taille relative des éléments des graphques (textes, légendes, …). Dans cet article, je vous partage quelques astuces qui me permettent d’arriver à mes objectifs et ceux de mes clients.</p>
<p><strong>Pré-requis</strong></p>
<ol style="list-style-type: decimal">
<li>Dans cette article je pars du principe que vous avez déjà créer un graphique avec <code>ggplot2</code> et que vous avez essayer de le personnaliser. Si ça n’est pas le cas, vous pouvez commencer par consulter <a href="https://ggplot2-book.org/">ce livre</a> disponible gratuitement en ligne. Ici on partira du graphique suivant :</li>
</ol>
<pre class="r"><code>library(ggplot2)
p &lt;- ggplot(iris, aes(x = Sepal.Length, y = Petal.Length, color = Species, fill = Species)) +
  geom_point() +
  geom_smooth(method = &quot;lm&quot;, formula = &quot;y ~ x&quot;, alpha = 0.3) +
  scale_color_viridis_d() +
  scale_fill_viridis_d()
p</code></pre>
<p><img src="/blog/2020-05-21-astuces-ggplot-rmarkdown/2020-05-21-astuces-ggplot-rmarkdown.fr_files/figure-html/unnamed-chunk-1-1.png" width="70%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>De même, vous êtes familier avec les documents R Markdown et vous savez ce qu’est un <em>chunk</em>. Dans le cas contraire, commencez <a href="https://bookdown.org/yihui/rmarkdown/">ici</a></li>
</ol>
<div id="créer-son-propre-thème-ggplot2" class="section level1">
<h1>Créer son propre thème <code>ggplot2</code></h1>
<p>Le thème <code>ggplot2</code> correspond à l’apparence du graphique. Il est possible de changer des éléments un par un via la fonction <a href="https://ggplot2.tidyverse.org/reference/theme.html"><code>theme()</code></a> mais il existe également des thèmes pré-configurés. Par défaut c’est <code>theme_gray()</code> qui est utilisé. Personnellement j’utilise plus souvent <code>theme_bw()</code> (pour black and white).</p>
<pre class="r"><code>p + labs(title = &quot;Thème par défaut&quot;)
p + theme_bw() + labs(title = &quot;Avec theme_bw()&quot;)</code></pre>
<p><img src="/blog/2020-05-21-astuces-ggplot-rmarkdown/2020-05-21-astuces-ggplot-rmarkdown.fr_files/figure-html/unnamed-chunk-2-.gif" width="70%" style="display: block; margin: auto;" /></p>
<p>Si vous appliquez souvent les mêmes changements via la fonction <code>theme()</code>, je vous recommande fortement de créer votre propre thème. Et un thème c’est avant tout une fonction. Voici un exemple de thème personnalisé :</p>
<pre class="r"><code>theme_ben &lt;- function(base_size = 14) {
  theme_bw(base_size = base_size) %+replace%
    theme(
      # L&#39;ensemble de la figure
      plot.title = element_text(size = rel(1), face = &quot;bold&quot;, margin = margin(0,0,5,0), hjust = 0),
      # Zone où se situe le graphique
      panel.grid.minor = element_blank(),
      panel.border = element_blank(),
      # Les axes
      axis.title = element_text(size = rel(0.85), face = &quot;bold&quot;),
      axis.text = element_text(size = rel(0.70), face = &quot;bold&quot;),
      axis.line = element_line(color = &quot;black&quot;, arrow = arrow(length = unit(0.3, &quot;lines&quot;), type = &quot;closed&quot;)),
      # La légende
      legend.title = element_text(size = rel(0.85), face = &quot;bold&quot;),
      legend.text = element_text(size = rel(0.70), face = &quot;bold&quot;),
      legend.key = element_rect(fill = &quot;transparent&quot;, colour = NA),
      legend.key.size = unit(1.5, &quot;lines&quot;),
      legend.background = element_rect(fill = &quot;transparent&quot;, colour = NA),
      # Les étiquettes dans le cas d&#39;un facetting
      strip.background = element_rect(fill = &quot;#17252D&quot;, color = &quot;#17252D&quot;),
      strip.text = element_text(size = rel(0.85), face = &quot;bold&quot;, color = &quot;white&quot;, margin = margin(5,0,5,0))
    )
}</code></pre>
<p>Et voici ce que ça donne en comparaison du thème par défaut :</p>
<pre class="r"><code>p + labs(title = &quot;Thème par défaut&quot;)
p + theme_ben() + labs(title = &quot;Avec mon thème personnalisé&quot;)</code></pre>
<p><img src="/blog/2020-05-21-astuces-ggplot-rmarkdown/2020-05-21-astuces-ggplot-rmarkdown.fr_files/figure-html/unnamed-chunk-4-.gif" width="70%" style="display: block; margin: auto;" /></p>
<p>Pour construire un thème personnalisé on crée donc une fonction R qui part d’un thème <code>ggplot2</code> existant qui se rapproche du résultat que l’on veut obtenir et dont on remplace les élèments avec la fonction <code>theme()</code>. L’astuce réside dans l’utilisation de <code>%+replace%</code> au lieu du traditionnel <code>+</code>. Contrairement à ce dernier, <code>%+replace%</code> ne fait pas que mettre à jour les éléments d’un thème mais les remplace totalement.</p>
<p>C’est maintenant qu’il faut faire intervenir votre créativité. La liste des éléments modifiables est très grande et donc la personnalisation très flexible. Si vous ne connaissez pas vraiment ces éléments, commencez par aller voir la page de la fonction <a href="https://ggplot2.tidyverse.org/reference/theme.html"><code>theme()</code></a>. Dans mon exemple, je fais des modifications sur l’ensemble de la figure (élément <code>plot.*</code>), sur la zone où est le graphique (<code>panel.*</code>), sur les axes (<code>axis.*</code>), la légende (<code>legend.*</code>) et les étiquettes des graphiques (<code>strip.*</code>) lorsque j’utilise du <a href="https://ggplot2-book.org/facet.html">facetting</a>.</p>
<p>Les axes et légendes sont pour moi des élèments essentiels et mes choix se portent principalement sur le fait de les mettre plus en valeur que dans le thème par défaut. Cela passe par la taille relative de chacun via l’utilisation de la fonction <code>rel()</code> qui retourne une proportion de la taille de base (<code>base_size</code>) et de la mise en gras (<code>face = "bold"</code>).</p>
<p>La modification d’un thème peut s’avérer laborieuse au départ mais si vous savez que vous utiliserez très souvent les mêmes réglages, le jeu en vaut la chandelle. Il existe tout un tas de ressources sur internet pour vous aider. N’hésitez pas également à me contacter (#ref), je me ferais un plaisir de vous aider.</p>
<p>Maintenant que c’est fait, vous pouvez intégrer ce thème dans un chunk au début de votre document R Markdown de sorte qu’il soit réutilisable tout le long du document. Vous pouvez également l’intégrer dans un package R (#ref), peut-être avec d’autres thèmes et charger ce package.</p>
</div>
<div id="votre-graphique-ggplot-dans-r-markdown" class="section level1">
<h1>Votre graphique <code>ggplot</code> dans R Markdown</h1>
<div id="options-des-chunks-pour-les-figures" class="section level2">
<h2>Options des chunks pour les figures</h2>
<p>Pour intégrer du code R et les résultats de ce code dans un document R Markdown vous utilisez un chunk R avec différentes options :</p>
<pre class="markdown"><code>```{r option1 = valeur_option1, option2 = valeur_option2}
# Le code R ici
```</code></pre>
<p>Certaines de ces options sont spécifiques pour les figures qui sont le résultat du code dans le chunk. Celles qui nous intéressent le plus ici sont :</p>
<ul>
<li><p>Les options relatives à la taille des figures générées par R</p></li>
<li><p>Les options relatives à la taille des figures dans le document final</p></li>
</ul>
</div>
<div id="taille-figures-générées-par-r" class="section level2">
<h2>Taille figures générées par R</h2>
<p>Les options <code>fig.width</code> et <code>fig.height</code> permettent respectivement de fixer la largeur et la hauteur de la figure générée par R. Par défaut, leur valeur est fixer à 7 (les dimensions sont en pouces). Une alternative que je préfère personnellement est d’utiliser une seule de ces valeurs (<code>fig.width</code>) en association avec une autre option <code>fig.asp</code> qui fixe le ratio <em>hauteur/largeur</em> de la figure. Il m’est personnellement plus facile de penser directement en terme de ratio que de donner une taille pour la largeur et une pour la hauteur séparément. Par défaut, <code>fig.asp</code> est <code>NULL</code> mais je le fixe très souvent à <span class="math inline">\(0,8\)</span> car c’est un ratio qui correspond très souvent au résultat que je cherche.</p>
<p>Les options de taille de la figure générée par R ont des conséquences sur la taille relative des éléments de la figure. Pour une figure <code>ggplot2</code>, les textes resteront à la taille définie dans le thème utilisée quelque soit la taille choisie. Un taille importante peut donner un rendu de texte trop petit et vice versa. Il y a donc une interaction entre la taille de votre thème et celle de la figure générée par R.</p>
<div class="grid-container">
<div class="row">
<div class="col-6">
<p><strong><code>fig.width = 3</code> - éléments du graphique relativement trop grands</strong></p>
<pre class="markdown"><code>```{r fig.asp = 0.8, fig.width = 3}
p + theme_ben()
```</code></pre>
<p><img src="/blog/2020-05-21-astuces-ggplot-rmarkdown/2020-05-21-astuces-ggplot-rmarkdown.fr_files/figure-html/unnamed-chunk-5-1.png" width="95%" style="display: block; margin: auto;" /></p>
</div>
<div class="col-6">
<p><strong><code>fig.width = 10</code> - éléments du graphique relativement trop petits</strong></p>
<pre class="markdown"><code>```{r fig.asp = 0.8, fig.width = 10}
p + theme_ben()
```</code></pre>
<p><img src="/blog/2020-05-21-astuces-ggplot-rmarkdown/2020-05-21-astuces-ggplot-rmarkdown.fr_files/figure-html/unnamed-chunk-6-1.png" width="95%" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>
<p>Pour avoir le rendu qui vous plaît, il vous faudra donc combiner entre les tailles choisies dans votre thème et celles utilisées dans les options du chunk. Pour mon thème, la taille par défaut (<code>7</code>) correspond à ce que je veux.</p>
<pre class="markdown"><code>```{r fig.asp = 0.8, fig.width = 7}
p + theme_ben()
```</code></pre>
<p><img src="/blog/2020-05-21-astuces-ggplot-rmarkdown/2020-05-21-astuces-ggplot-rmarkdown.fr_files/figure-html/unnamed-chunk-7-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p>Il est cependant possible que je fasse évoluer cette taille ponctuellement. Par exemple lorsque les textes des axes sont plus longs ou que le graphique est chargée, je peux choisir une taille plus importante (<code>8</code> ou <code>9</code>) pour que que les éléments du graphique soit relativement plus petit. Notez que pour le texte, une simple modification de la taille de base dans le thème suffit.</p>
<div class="grid-container">
<div class="row">
<div class="col-6">
<p><strong><code>fig.width = 9</code> - <code>base_size = 14</code> (défaut)</strong></p>
<pre class="markdown"><code>```{r fig.asp = 0.8, fig.width = 9}
p + theme_ben(base_size = 14)
```</code></pre>
<p><img src="/blog/2020-05-21-astuces-ggplot-rmarkdown/2020-05-21-astuces-ggplot-rmarkdown.fr_files/figure-html/unnamed-chunk-8-1.png" width="95%" style="display: block; margin: auto;" /></p>
</div>
<div class="col-6">
<p><strong><code>fig.width = 7</code> (défaut) - <code>base_size = 12</code></strong></p>
<pre class="markdown"><code>```{r fig.asp = 0.8, fig.width = 7}
p + theme_ben(base_size = 12)
```</code></pre>
<p><img src="/blog/2020-05-21-astuces-ggplot-rmarkdown/2020-05-21-astuces-ggplot-rmarkdown.fr_files/figure-html/unnamed-chunk-9-1.png" width="95%" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>
</div>
<div id="taille-de-la-figure-dans-le-document" class="section level2">
<h2>Taille de la figure dans le document</h2>
<p>Les figures générées par R dans un document RMarkdown sont exportées (en format png par défaut) avant d’être insérées dans le document final quelque soit sont format. Il est possible de modifier la taille de la figure dans le document final avec les options <code>out.width</code> et <code>out.height</code>.</p>
<p>Il est rare que j’ai à revoir le ratio entre hauteur et largeur après avoir généré la figure dans R, j’utilise donc quasi systématiquement uniquement <code>out.width</code>. La solution qui me paraît la plus favorable pour définir une valeur est en pourcentage. Ainsi, une valeur de 100% donne :</p>
<pre class="markdown"><code>```{r fig.asp = 0.8, fig.width = 7, out.width = &quot;100%}
p + theme_ben()
```</code></pre>
<p><img src="/blog/2020-05-21-astuces-ggplot-rmarkdown/2020-05-21-astuces-ggplot-rmarkdown.fr_files/figure-html/unnamed-chunk-10-1.png" width="100%" style="display: block; margin: auto;" /></p>
<p>tandis qu’une valeur de 50% donne :</p>
<pre class="markdown"><code>```{r fig.asp = 0.8, fig.width = 7, out.width = &quot;50%}
p + theme_ben()
```</code></pre>
<p><img src="/blog/2020-05-21-astuces-ggplot-rmarkdown/2020-05-21-astuces-ggplot-rmarkdown.fr_files/figure-html/unnamed-chunk-11-1.png" width="50%" style="display: block; margin: auto;" /></p>
<p>Vous voyez que cette fois-ci, la taille relative des éléments est inchangée. Le graphique est le même, il est simplement montré avec une taille plus ou moins grande.</p>
</div>
</div>
<div id="éviter-de-vous-répéter" class="section level1">
<h1>Éviter de vous répéter</h1>
<p>Il est toujours frustrant de devoir écrire plusieurs fois la même chose dans une document. Ici, à chaque chunk avec une figre <code>ggplot2</code>, il faut préciser notre nouveau thème et les valeurs des options duchunk correspondant à la taille de la figure. Pas de panique, il existe des solutions pour combler votre (ma!) fainéantise.</p>
<div id="changer-le-thème-ggplot2-par-défaut" class="section level4">
<h4>Changer le thème <code>ggplot2</code> par défaut</h4>
<p>Vous pouvez changer le thème par défaut pour <code>ggplot2</code> avec la fonction <code>theme_set()</code>. Il suffit pour cela de mettre après création de votre thème (ou chargement du package le contenant) la commande :</p>
<pre class="r"><code>theme_set(theme_ben()) # remplacer theme_ben() par le nom du thème voulu</code></pre>
</div>
<div id="changer-les-valeurs-par-défaut-des-options-chunk" class="section level4">
<h4>Changer les valeurs par défaut des options chunk</h4>
<p>Vous pouvez changer les valeurs par défaut des options chunk avec ce chunk en début de document :</p>
<pre class="markdown"><code>```{r setup, include=FALSE}
knitr::opts_chunk$set(
 fig.width = 6,
 fig.asp = 0.8,
 out.width = &quot;80%&quot;
)
```</code></pre>
<p>Ces valeurs seront appliquées à tous les chunk de votre document à moins que vous n’en spécifiez d’autres ponctuellement. Vous pouvez alors mettre les options que vous utilisez souvent et éviter d’avoir à les recopier à chaque fois.</p>
</div>
<div id="à-quoi-peut-ressembler-le-début-de-votre-document-r-markdown" class="section level4">
<h4>À quoi peut ressembler le début de votre document R Markdown</h4>
<p>Avec ces astuces, voilà à quoi peut ressembler le début d’un document RMarkdown dont la sortie sera sous format HTML :</p>
<pre class="markdown"><code>---
title: &quot;Mon super titre&quot;
author: &quot;Benjamin Louis&quot;
date: &quot;25/05/2020&quot;
output: html_document
---


```{r setup, include=FALSE}
# Option de chunk
knitr::opts_chunk$set(
 fig.width = 6,
 fig.asp = 0.8,
 out.width = &quot;80%&quot;
)
```

```{r theme_ggplot2, echo = FALSE}
# Création du thème ggplot2
library(ggplot)
theme_ben &lt;- function(base_size = 14) {
  theme_bw(base_size = base_size) %+replace%
    theme(
      # Les options du thème
    )
}
# Changement du thème par défaut
theme_set(theme_ben())
```</code></pre>
<p>À vous désormais de modifier tout ce que vous voulez pour créer un thème ggplot2 et mettre vos valeurs préférées d’options chunk par défaut. Ces options ne se limitent pas à celles des figures R, n’hésitez pas à consulter <a href="https://yihui.org/knitr/options/">cette page</a> pour en découvrir d’autres.</p>
<p>J’espère que cette article vous aura aider à écrire des rapports qui vous plaisent et n’hésitez pas à partager vos astuces en commentaire.</p>
</div>
</div>
